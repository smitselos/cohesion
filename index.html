<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Î£Ï…Î½Î¿Ï‡Î®Ï‚ & Î£Ï…Î½ÎµÎºÏ„Î¹ÎºÏŒÏ„Î·Ï„Î±Ï‚ - Î‘' Î›Ï…ÎºÎµÎ¯Î¿Ï…</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
            min-height: 100vh;
            padding: 16px;
            line-height: 1.6;
        }
        
        .container { max-width: 900px; margin: 0 auto; }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 24px;
            margin-bottom: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .header h1 { font-size: 1.5rem; color: #1e293b; }
        .header-subtitle { color: #64748b; font-size: 0.875rem; }
        
        .question-counter { text-align: right; }
        .question-counter p {
            color: #64748b;
            font-size: 0.875rem;
            margin-bottom: 4px;
        }
        .question-counter span {
            font-size: 1.75rem;
            font-weight: 700;
            color: #4f46e5;
        }
        
        @media (max-width: 600px) {
            .header {
                gap: 8px;
            }
            .header h1 {
                font-size: 1.1rem;
            }
            .header-subtitle {
                font-size: 0.75rem;
                display: none; /* Î‘Ï€ÏŒÎºÏÏ…ÏˆÎ· subtitle ÏƒÎµ mobile */
            }
            .question-counter p {
                font-size: 0.7rem;
                margin-bottom: 2px;
            }
            .question-counter span {
                font-size: 1.3rem;
            }
            .card {
                padding: 16px; /* Î›Î¹Î³ÏŒÏ„ÎµÏÎ¿ padding ÏƒÎµ mobile */
            }
        }
        
        .progress-bar {
            background: #e2e8f0;
            border-radius: 999px;
            height: 8px;
            margin-top: 16px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: #4f46e5;
            height: 100%;
            transition: width 0.3s ease;
        }
        
        /* ÎŸÎ¸ÏŒÎ½Î· Î•Ï€Î¹Î»Î¿Î³ÏÎ½ */
        .selection-screen { text-align: center; }
        .selection-screen h2 {
            color: #1e293b;
            margin-bottom: 8px;
            font-size: 1.75rem;
        }
        .selection-screen p {
            color: #64748b;
            margin-bottom: 24px;
        }
        
        .filter-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: left;
        }
        
        .filter-section h3 {
            color: #374151;
            font-size: 1rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .filter-btn {
            padding: 10px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .filter-btn:hover { border-color: #94a3b8; }
        
        .filter-btn.selected {
            border-color: #4f46e5;
            background: #4f46e5;
            color: white;
            font-weight: 600;
        }
        
        .start-btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            background: #4f46e5;
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }
        
        .start-btn:hover { background: #3730a3; }
        .start-btn:disabled {
            background: #e2e8f0;
            color: #94a3b8;
            cursor: not-allowed;
        }
        
        /* Loading */
        .loading { text-align: center; padding: 60px 20px; }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Quiz */
        .text-label {
            display: inline-block;
            background: #e0e7ff;
            color: #3730a3;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .question-text {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #1e293b;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            border-radius: 12px;
            line-height: 1.8;
            font-size: 1rem;
            border-left: 4px solid #4f46e5;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .question-prompt {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            font-weight: 600;
            color: #374151;
        }
        
        .options-container {
            background: #faf5ff;
            border: 1px solid #e9d5ff;
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
        }
        
        .options-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .option-btn {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
            position: relative;
        }
        
        .option-btn:hover:not(:disabled) { border-color: #94a3b8; }
        .option-btn.selected { border-color: #4f46e5; background: #eef2ff; }
        .option-btn.correct-answer { 
            border-color: #047857; 
            background: #059669; 
            color: white;
            font-weight: 600;
        }
        .option-btn.correct-answer::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            right: 16px;
            transform: translateY(-50%);
            font-size: 1.2rem;
            font-weight: bold;
        }
        .option-btn.wrong-answer { 
            border-color: #b91c1c; 
            background: #dc2626; 
            color: white;
            font-weight: 600;
        }
        .option-btn.wrong-answer::after {
            content: 'âœ—';
            position: absolute;
            top: 50%;
            right: 16px;
            transform: translateY(-50%);
            font-size: 1.2rem;
            font-weight: bold;
        }
        .option-btn:disabled { cursor: default; }
        
        /* Gap Input */
        .gap-input-container {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 14px;
            font-size: 1rem;
            border-radius: 10px;
            border: 2px solid #c7d2fe;
            transition: all 0.2s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #4f46e5;
        }
        
        input.correct {
            background: #ecfdf5;
            border-color: #059669;
        }
        
        input.wrong {
            background: #fee2e2;
            border-color: #dc2626;
        }
        
        .check-gap-btn {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            background: #4f46e5;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .check-gap-btn:hover { background: #3730a3; }
        .check-gap-btn:disabled { 
            background: #e2e8f0; 
            color: #94a3b8; 
            cursor: not-allowed; 
        }
        
        /* Matching (Drag & Drop) */
        .matching-hint {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            color: #1e40af;
            font-size: 0.875rem;
            text-align: center;
        }
        
        .matching-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .matching-column {
            background: white;
            border-radius: 12px;
            padding: 16px;
            min-height: 200px;
        }
        
        .matching-column h4 {
            color: #374151;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 12px;
            text-align: center;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .matching-item {
            padding: 12px 14px;
            margin-bottom: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: grab;
            transition: all 0.2s;
            position: relative;
            user-select: none;
        }
        
        .matching-item:active {
            cursor: grabbing;
        }
        
        .matching-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        
        .matching-item.drag-over {
            border-color: #4f46e5;
            background: #eef2ff;
            border-style: dashed;
        }
        
        .matching-item.matched {
            border-color: #059669;
            background: #ecfdf5;
            cursor: default;
        }
        
        .matching-item.matched::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            color: #059669;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .matching-item.wrong {
            border-color: #dc2626;
            background: #fee2e2;
        }
        
        .matching-item.wrong::after {
            content: 'âœ—';
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            color: #dc2626;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .matching-label {
            display: inline-block;
            background: #4f46e5;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 8px;
        }
        
        .drop-zone {
            min-height: 50px;
            border: 2px dashed #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            background: #f8fafc;
            transition: all 0.2s;
        }
        
        .drop-zone.drag-over {
            border-color: #4f46e5;
            background: #eef2ff;
        }
        
        .drop-zone.filled {
            border-style: solid;
            border-color: #94a3b8;
            background: white;
        }
        
        .drop-zone-label {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        /* Pick Words */
        .pick-words-hint {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            color: #1e40af;
            font-size: 0.875rem;
            text-align: center;
        }
        
        .pick-words-text {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #1e293b;
            padding: 20px;
            border-radius: 12px;
            line-height: 2;
            font-size: 1rem;
            border-left: 4px solid #4f46e5;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .pickable-word {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            transition: all 0.2s;
            display: inline-block;
        }
        
        .pickable-word:hover {
            background: #fef3c7;
        }
        
        .pickable-word.selected {
            background: #ecfdf5;
            color: #047857;
            font-weight: 600;
            border-bottom: 2px solid #059669;
        }
        
        .pickable-word.correct {
            background: #ecfdf5;
            color: #047857;
            font-weight: 600;
            border-bottom: 2px solid #059669;
            animation: pulse-green 0.6s ease-in-out;
        }
        
        @keyframes pulse-green {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .pick-words-counter {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 10px;
            margin-top: 12px;
            text-align: center;
            font-size: 0.875rem;
            color: #92400e;
            font-weight: 500;
        }
        
        /* Feedback */
        .feedback-container {
            margin-top: 20px;
        }
        
        .correct-answer-box {
            background: #ecfdf5;
            border: 1px solid #059669;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .correct-answer-box h4 {
            color: #065f46;
            font-size: 0.95rem;
            margin-bottom: 8px;
        }
        
        .correct-answer-box p {
            color: #047857;
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        .notes-box {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .notes-box h4 {
            color: #92400e;
            font-size: 0.95rem;
            margin-bottom: 8px;
        }
        
        .notes-box p {
            color: #78350f;
            font-size: 0.875rem;
            line-height: 1.6;
        }
        
        .main-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .main-btn.primary { background: #4f46e5; color: white; }
        .main-btn.primary:hover { background: #3730a3; }
        .main-btn.success { background: #16a34a; color: white; }
        .main-btn.success:hover { background: #15803d; }
        .main-btn:disabled { 
            background: #e2e8f0; 
            color: #94a3b8; 
            cursor: not-allowed; 
        }
        
        .hint-btn {
            background: #fef3c7;
            color: #92400e;
            border: 2px solid #fcd34d;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 12px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .hint-btn:hover {
            background: #fde68a;
            border-color: #f59e0b;
            transform: translateY(-2px);
        }
        
        .hint-box {
            background: #fffbeb;
            border: 2px solid #fcd34d;
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
            display: none;
        }
        
        .hint-box.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .hint-box h4 {
            color: #92400e;
            font-size: 0.95rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .hint-box p {
            color: #78350f;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .sound-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .sound-toggle:hover {
            border-color: #4f46e5;
            transform: scale(1.05);
        }
        
        .sound-toggle svg {
            width: 24px;
            height: 24px;
            color: #4f46e5;
        }
        
        .sound-toggle.muted {
            background: #fee2e2;
            border-color: #dc2626;
        }
        
        .sound-toggle.muted svg {
            color: #dc2626;
        }
        
        /* Results */
        .results-card { text-align: center; padding: 40px 24px; }
        .results-emoji { font-size: 4rem; margin-bottom: 16px; }
        .results-title { font-size: 1.75rem; color: #1e293b; margin-bottom: 24px; }
        
        .results-score-box {
            background: linear-gradient(135deg, #eef2ff 0%, #faf5ff 100%);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .results-score { font-size: 3rem; font-weight: 700; color: #4f46e5; }
        .results-percentage { color: #64748b; font-size: 1.1rem; }
        
        .wrong-questions-section {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: left;
        }
        
        .wrong-questions-section h3 {
            color: #92400e;
            font-size: 1.1rem;
            margin-bottom: 12px;
        }
        
        .repeat-btn {
            background: #f59e0b;
            color: white;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 12px;
        }
        
        .repeat-btn:hover { background: #d97706; }
        
        @media (max-width: 600px) {
            .header { flex-direction: column; align-items: flex-start; }
            .gap-input-container { flex-direction: column; }
            .matching-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <div class="card loading">
            <div class="loading-spinner"></div>
            <p>Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½...</p>
        </div>
    </div>

    <script>
        // =====================================================
        // Î¡Î¥Î˜ÎœÎ™Î£Î•Î™Î£
        // =====================================================
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSBmZdhLakrSUcbxWqSdNo5O07jxI7YRJ_J890qyb-u0qqoOqe1RMl18UQx0SFbLBo2Ihdm6gOOnelY/pub?output=csv';

        let allData = [];
        let questions = [];
        let wrongQuestions = [];
        
        let state = {
            screen: 'loading',
            selectedLevel: null,
            selectedCount: null,
            currentQuestion: 0,
            answered: false,
            correctCount: 0,
            soundEnabled: true, // Sound on by default
            // Matching state
            matchingPairs: {},
            draggedItem: null,
            // Pick words state
            selectedWords: new Set(),
            requiredWords: []
        };

        // =====================================================
        // Î—Î§ÎŸÎ™
        // =====================================================
        
        function playCorrectSound() {
            if (!state.soundEnabled) return;
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }
        
        function playWrongSound() {
            if (!state.soundEnabled) return;
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 200;
            oscillator.type = 'sawtooth';
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }
        
        function toggleSound() {
            state.soundEnabled = !state.soundEnabled;
            updateSoundButton();
        }
        
        function updateSoundButton() {
            const btn = document.getElementById('soundToggle');
            if (!btn) return;
            
            if (state.soundEnabled) {
                btn.classList.remove('muted');
                btn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11 5L6 9H2V15H6L11 19V5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M15.54 8.46C16.4774 9.39764 17.0039 10.6692 17.0039 11.995C17.0039 13.3208 16.4774 14.5924 15.54 15.53" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                `;
                btn.title = 'Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î®Ï‡Î¿Ï…';
            } else {
                btn.classList.add('muted');
                btn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11 5L6 9H2V15H6L11 19V5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="23" y1="9" x2="17" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="17" y1="9" x2="23" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                `;
                btn.title = 'Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î®Ï‡Î¿Ï…';
            }
        }

        // =====================================================
        // DATA LOADING
        // =====================================================
        
        function parseCSV(text) {
            const rows = [];
            let row = [], cell = '', inQuotes = false;
            
            for (let i = 0; i < text.length; i++) {
                const ch = text[i], next = text[i + 1];
                if (ch === '"' && inQuotes && next === '"') { cell += '"'; i++; }
                else if (ch === '"') { inQuotes = !inQuotes; }
                else if (ch === ',' && !inQuotes) { row.push(cell); cell = ''; }
                else if ((ch === '\n' || ch === '\r') && !inQuotes) {
                    if (cell || row.length) { row.push(cell); rows.push(row); }
                    row = []; cell = '';
                } else cell += ch;
            }
            if (cell || row.length) { row.push(cell); rows.push(row); }
            
            const headers = rows.shift();
            return rows.map(r => {
                let obj = {};
                headers.forEach((k, i) => obj[k] = r[i] || '');
                return obj;
            });
        }
        
        function normalize(str) {
            return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
        }
        
        async function loadData() {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const csv = await response.text();
                allData = parseCSV(csv);
                
                if (allData.length === 0) {
                    console.warn('No data loaded from CSV');
                }
                
                state.screen = 'selection';
                render();
            } catch (error) {
                console.error('Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚:', error);
                // Î ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î± Î¼Îµ direct Google Sheets URL
                try {
                    const directUrl = CSV_URL.replace('/pub?', '/pub?gid=0&single=true&');
                    const response2 = await fetch(directUrl);
                    const csv2 = await response2.text();
                    allData = parseCSV(csv2);
                    state.screen = 'selection';
                    render();
                } catch (error2) {
                    // Fallback - Î´ÎµÎ¯Î¾Îµ Ï„Î·Î½ Î¿Î¸ÏŒÎ½Î· ÎµÏ€Î¹Î»Î¿Î³Î®Ï‚ Î¿ÏÏ„Ï‰Ï‚ Î® Î¬Î»Î»Ï‰Ï‚
                    console.error('Î”ÎµÏÏ„ÎµÏÎ· Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î± Î±Ï€Î­Ï„Ï…Ï‡Îµ:', error2);
                    state.screen = 'selection';
                    render();
                    
                    // Î”ÎµÎ¯Î¾Îµ Î¼Î®Î½Ï…Î¼Î± ÏƒÏ„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î·
                    setTimeout(() => {
                        const app = document.getElementById('app');
                        if (allData.length === 0) {
                            app.innerHTML = `
                                <div class="card" style="text-align: center; padding: 40px;">
                                    <h2 style="color: #dc2626; margin-bottom: 16px;">âš ï¸ Î ÏÏŒÎ²Î»Î·Î¼Î± Î¦ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚</h2>
                                    <p style="color: #64748b; margin-bottom: 20px;">
                                        Î”ÎµÎ½ Î¼Ï€ÏŒÏÎµÏƒÎ±Î½ Î½Î± Ï†Î¿ÏÏ„ÏÏƒÎ¿Ï…Î½ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î±Ï€ÏŒ Ï„Î¿ Google Sheet.<br>
                                        Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î· ÏƒÏÎ½Î´ÎµÏƒÎ® ÏƒÎ±Ï‚ ÏƒÏ„Î¿ internet.
                                    </p>
                                    <button class="start-btn" onclick="location.reload()">
                                        ğŸ”„ Î”Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ ÎÎ±Î½Î¬
                                    </button>
                                </div>
                            `;
                        }
                    }, 500);
                }
            }
        }

        // =====================================================
        // RENDERING
        // =====================================================
        
        function render() {
            const app = document.getElementById('app');
            
            switch (state.screen) {
                case 'loading':
                    app.innerHTML = renderLoading();
                    break;
                case 'selection':
                    app.innerHTML = renderSelection();
                    break;
                case 'quiz':
                    app.innerHTML = renderQuiz();
                    // Add sound toggle button
                    if (!document.getElementById('soundToggle')) {
                        const soundBtn = document.createElement('button');
                        soundBtn.id = 'soundToggle';
                        soundBtn.className = 'sound-toggle';
                        document.body.appendChild(soundBtn);
                        updateSoundButton();
                        soundBtn.addEventListener('click', toggleSound);
                    }
                    break;
                case 'results':
                    app.innerHTML = renderResults();
                    // Remove sound button on results screen
                    const existingBtn = document.getElementById('soundToggle');
                    if (existingBtn) existingBtn.remove();
                    break;
            }
            
            attachEventListeners();
        }
        
        function renderLoading() {
            return `
                <div class="card loading">
                    <div class="loading-spinner"></div>
                    <p>Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½...</p>
                </div>
            `;
        }
        
        function renderSelection() {
            return `
                <div class="card selection-screen">
                    <h2>ğŸ“ Quiz Î£Ï…Î½Î¿Ï‡Î®Ï‚ & Î£Ï…Î½ÎµÎºÏ„Î¹ÎºÏŒÏ„Î·Ï„Î±Ï‚</h2>
                    <p>ÎÎµÎ¿ÎµÎ»Î»Î·Î½Î¹ÎºÎ® Î“Î»ÏÏƒÏƒÎ± - Î›ÏÎºÎµÎ¹Î¿</p>
                    
                    <div class="filter-section">
                        <h3>ğŸ“Š Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î•Ï€Î¯Ï€ÎµÎ´Î¿</h3>
                        <div class="filter-options">
                            <button class="filter-btn ${state.selectedLevel === 1 ? 'selected' : ''}" data-level="1">
                                Î•Ï€Î¯Ï€ÎµÎ´Î¿ 1 - Î Î¿Î»Î»Î±Ï€Î»Î® Î•Ï€Î¹Î»Î¿Î³Î®
                            </button>
                            <button class="filter-btn ${state.selectedLevel === 2 ? 'selected' : ''}" data-level="2">
                                Î•Ï€Î¯Ï€ÎµÎ´Î¿ 2 - Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎ· ÎšÎµÎ½Î¿Ï
                            </button>
                            <button class="filter-btn ${state.selectedLevel === 3 ? 'selected' : ''}" data-level="3">
                                Î•Ï€Î¯Ï€ÎµÎ´Î¿ 3 - Î‘Î½Ï„Î¹ÏƒÏ„Î¿Î¯Ï‡Î¹ÏƒÎ·
                            </button>
                            <button class="filter-btn ${state.selectedLevel === 4 ? 'selected' : ''}" data-level="4">
                                Î•Ï€Î¯Ï€ÎµÎ´Î¿ 4 - Î•Ï€Î¹Î»Î¿Î³Î® Î›Î­Î¾ÎµÏ‰Î½
                            </button>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <h3>ğŸ”¢ Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Î‘ÏƒÎºÎ®ÏƒÎµÏ‰Î½</h3>
                        <div class="filter-options">
                            <button class="filter-btn ${state.selectedCount === 1 ? 'selected' : ''}" data-count="1">1</button>
                            <button class="filter-btn ${state.selectedCount === 10 ? 'selected' : ''}" data-count="10">10</button>
                            <button class="filter-btn ${state.selectedCount === 'all' ? 'selected' : ''}" data-count="all">ÎŒÎ»ÎµÏ‚</button>
                        </div>
                    </div>
                    
                    <button class="start-btn" id="startBtn" ${state.selectedLevel === null || state.selectedCount === null ? 'disabled' : ''}>
                        ÎÎµÎºÎ¹Î½Î®ÏƒÏ„Îµ Ï„Î¿ Quiz
                    </button>
                </div>
            `;
        }
        
        function renderQuiz() {
            const q = questions[state.currentQuestion];
            const progress = ((state.currentQuestion + 1) / questions.length) * 100;
            
            return `
                <div class="card">
                    <div class="header">
                        <div>
                            <h1>ğŸ“ Î£Ï…Î½Î¿Ï‡Î® & Î£Ï…Î½ÎµÎºÏ„Î¹ÎºÏŒÏ„Î·Ï„Î±</h1>
                            <p class="header-subtitle">ÎÎµÎ¿ÎµÎ»Î»Î·Î½Î¹ÎºÎ® Î“Î»ÏÏƒÏƒÎ± - Î›ÏÎºÎµÎ¹Î¿</p>
                        </div>
                        <div class="question-counter">
                            <p style="color: #64748b; font-size: 0.875rem;">Î†ÏƒÎºÎ·ÏƒÎ·</p>
                            <span>${state.currentQuestion + 1}/${questions.length}</span>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                </div>

                <div class="card">
                    <span class="text-label">ÎšÎµÎ¯Î¼ÎµÎ½Î¿ ${state.currentQuestion + 1}</span>
                    ${q.question_type !== 'pick_words' ? `
                        <div class="question-text">${q.text}</div>
                        <div class="question-prompt">${q.question}</div>
                    ` : ''}
                    ${q.question_type === 'pick_words' ? `
                        <div class="question-prompt">${q.question}</div>
                    ` : ''}
                    
                    ${q['Î’Î¿Î®Î¸ÎµÎ¹Î±'] && q['Î’Î¿Î®Î¸ÎµÎ¹Î±'].trim() !== '' && !state.answered ? `
                        <button class="hint-btn" id="hintBtn">
                            ğŸ’¡ Î’Î¿Î®Î¸ÎµÎ¹Î±
                        </button>
                        <div class="hint-box" id="hintBox">
                            <h4>ğŸ’¡ Î¥Ï€ÏŒÎ´ÎµÎ¹Î¾Î·:</h4>
                            <p>${q['Î’Î¿Î®Î¸ÎµÎ¹Î±']}</p>
                        </div>
                    ` : ''}
                </div>

                ${renderQuestionType(q)}

                <div id="feedback"></div>
            `;
        }
        
        function renderQuestionType(q) {
            switch(q.question_type) {
                case 'multiple_choice':
                    return renderMultipleChoice(q);
                case 'fill_gap':
                    return renderFillGap(q);
                case 'matching':
                    return renderMatching(q);
                case 'pick_words':
                    return renderPickWords(q);
                default:
                    return '';
            }
        }
        
        function renderMultipleChoice(q) {
            return `
                <div class="options-container">
                    <div class="options-list">
                        ${[q.option1, q.option2, q.option3, q.option4].map((option, i) => `
                            <button class="option-btn" data-value="${i + 1}" ${state.answered ? 'disabled' : ''}>
                                ${option}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderFillGap(q) {
            return `
                <div class="options-container">
                    <div class="gap-input-container">
                        <input type="text" id="gapInput" placeholder="Î“ÏÎ¬ÏˆÎµ Ï„Î·Î½ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ® ÏƒÎ¿Ï…..." ${state.answered ? 'disabled' : ''}>
                        <button class="check-gap-btn" id="checkGapBtn" ${state.answered ? 'disabled' : ''}>
                            ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚
                        </button>
                    </div>
                </div>
            `;
        }
        
        function renderMatching(q) {
            // Parse columns
            const leftItems = q.left_column ? q.left_column.split(',').map(s => s.trim()) : [];
            const rightItems = q.right_column ? q.right_column.split(',').map(s => s.trim()) : [];
            
            // Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î±Î½Î¬Î¸ÎµÏƒÎ· ÎµÎ»Î»Î·Î½Î¹ÎºÏÎ½ labels (Î‘, Î’, Î“, Î”, Î•, Î–...)
            const greekLabels = ['Î‘', 'Î’', 'Î“', 'Î”', 'Î•', 'Î–', 'Î—', 'Î˜'];
            
            return `
                <div class="options-container">
                    <div class="matching-hint">
                        ğŸ’¡ Î£ÏÏÎµÏ„Îµ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Î±Ï€ÏŒ Ï„Î·Î½ Î±ÏÎ¹ÏƒÏ„ÎµÏÎ® ÏƒÏ„Î®Î»Î· ÎºÎ±Î¹ Î±Ï†Î®ÏƒÏ„Îµ Ï„Î± ÏƒÏ„Î·Î½ Î±Î½Ï„Î¯ÏƒÏ„Î¿Î¹Ï‡Î· Î¸Î­ÏƒÎ· Ï„Î·Ï‚ Î´ÎµÎ¾Î¹Î¬Ï‚ ÏƒÏ„Î®Î»Î·Ï‚
                    </div>
                    <div class="matching-container">
                        <div class="matching-column">
                            <h4>Î‘ÏÎ¹ÏƒÏ„ÎµÏÎ® Î£Ï„Î®Î»Î·</h4>
                            <div id="leftColumn">
                                ${leftItems.map((item, i) => {
                                    const label = greekLabels[i] || String.fromCharCode(913 + i); // 913 = Î‘
                                    return `
                                        <div class="matching-item" draggable="true" data-left-id="${i}" data-label="${label}">
                                            <span class="matching-label">${label}</span>
                                            ${item}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        <div class="matching-column">
                            <h4>Î”ÎµÎ¾Î¹Î¬ Î£Ï„Î®Î»Î·</h4>
                            <div id="rightColumn">
                                ${rightItems.map((item, i) => `
                                    <div class="drop-zone" data-right-id="${i}">
                                        <div class="drop-zone-label">${i + 1}. ${item}</div>
                                        <div class="drop-zone-content"></div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <button class="main-btn primary" id="checkMatchingBtn" style="margin-top: 16px;" ${Object.keys(state.matchingPairs).length < leftItems.length ? 'disabled' : ''}>
                        ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î‘Ï€Î±Î½Ï„Î®ÏƒÎµÏ‰Î½
                    </button>
                </div>
            `;
        }
        
        function renderPickWords(q) {
            // Parse required words from answer (Î´Î¹Î±Ï‡Ï‰ÏÎ¹ÏƒÎ¼Î­Î½ÎµÏ‚ Î¼Îµ ÎºÎµÎ½ÏŒ)
            state.requiredWords = q.answer ? q.answer.split(' ').map(w => w.trim()).filter(Boolean) : [];
            
            // Make ALL words clickable
            const words = q.text.split(' ');
            const textHTML = words.map((word, i) => {
                const cleanWord = word.replace(/[.,;!?]/g, '');
                const isSelected = state.selectedWords.has(cleanWord);
                const isCorrect = state.requiredWords.some(rw => normalize(rw) === normalize(cleanWord));
                
                // ÎŒÎ»ÎµÏ‚ Î¿Î¹ Î»Î­Î¾ÎµÎ¹Ï‚ ÎµÎ¯Î½Î±Î¹ clickable
                return `<span class="pickable-word ${isSelected ? 'selected' : ''}" data-word="${cleanWord}" data-is-correct="${isCorrect}">${word}</span>`;
            }).join(' ');
            
            return `
                <div class="options-container">
                    <div class="pick-words-hint">
                        ğŸ’¡ ÎšÎ¬Î½Ï„Îµ ÎºÎ»Î¹Îº ÏƒÏ„Î¹Ï‚ Î»Î­Î¾ÎµÎ¹Ï‚ Ï€Î¿Ï… Ï€Î¹ÏƒÏ„ÎµÏÎµÏ„Îµ ÏŒÏ„Î¹ ÎµÎ¯Î½Î±Î¹ ÏƒÏ‰ÏƒÏ„Î­Ï‚. ÎŸÎ¹ ÏƒÏ‰ÏƒÏ„Î­Ï‚ Î»Î­Î¾ÎµÎ¹Ï‚ Î¸Î± Ï€ÏÎ±ÏƒÎ¹Î½Î¯ÏƒÎ¿Ï…Î½.
                    </div>
                    <div class="pick-words-text">
                        ${textHTML}
                    </div>
                    <div class="pick-words-counter">
                        ÎˆÏ‡ÎµÏ„Îµ ÎµÏ€Î¹Î»Î­Î¾ÎµÎ¹ ÏƒÏ‰ÏƒÏ„Î¬: ${state.selectedWords.size} / ${state.requiredWords.length} Î»Î­Î¾ÎµÎ¹Ï‚
                    </div>
                    <button class="main-btn primary" id="checkPickWordsBtn" style="margin-top: 16px;" ${state.selectedWords.size !== state.requiredWords.length ? 'disabled' : ''}>
                        ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î‘Ï€Î±Î½Ï„Î®ÏƒÎµÏ‰Î½
                    </button>
                </div>
            `;
        }
        
        function renderResults() {
            const percentage = Math.round((state.correctCount / questions.length) * 100);
            const emoji = percentage >= 80 ? 'ğŸ‰' : percentage >= 60 ? 'ğŸ‘' : 'ğŸ“š';
            
            return `
                <div class="card results-card">
                    <div class="results-emoji">${emoji}</div>
                    <h2 class="results-title">ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎµÏ‚ Ï„Î¿ Quiz!</h2>
                    
                    <div class="results-score-box">
                        <p class="results-score">${state.correctCount} / ${questions.length}</p>
                        <p class="results-percentage">(${percentage}%)</p>
                    </div>

                    ${wrongQuestions.length > 0 ? `
                        <div class="wrong-questions-section">
                            <h3>ğŸ“Œ ÎˆÏ‡ÎµÎ¹Ï‚ ${wrongQuestions.length} Î»Î±Î½Î¸Î±ÏƒÎ¼Î­Î½Î·/ÎµÏ‚ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·/ÎµÎ¹Ï‚</h3>
                            <button class="repeat-btn" id="repeatBtn">
                                ğŸ” Î•Ï€Î±Î½Î¬Î»Î·ÏˆÎ· Î›Î±Î½Î¸Î±ÏƒÎ¼Î­Î½Ï‰Î½
                            </button>
                        </div>
                    ` : ''}

                    <button class="main-btn primary" id="homeBtn">
                        â¬… Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î·Î½ Î‘ÏÏ‡Î®
                    </button>
                </div>
            `;
        }

        // =====================================================
        // EVENT LISTENERS
        // =====================================================
        
        function attachEventListeners() {
            // Selection screen
            document.querySelectorAll('[data-level]').forEach(btn => {
                btn.addEventListener('click', () => {
                    state.selectedLevel = parseInt(btn.dataset.level);
                    render();
                });
            });
            
            document.querySelectorAll('[data-count]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const count = btn.dataset.count;
                    state.selectedCount = count === 'all' ? 'all' : parseInt(count);
                    render();
                });
            });
            
            const startBtn = document.getElementById('startBtn');
            if (startBtn) {
                startBtn.addEventListener('click', startQuiz);
            }
            
            // Quiz screen - Multiple Choice
            let selectedOption = null;
            
            // Hint button
            const hintBtn = document.getElementById('hintBtn');
            const hintBox = document.getElementById('hintBox');
            if (hintBtn && hintBox) {
                hintBtn.addEventListener('click', () => {
                    if (hintBox.classList.contains('show')) {
                        hintBox.classList.remove('show');
                        hintBtn.textContent = 'ğŸ’¡ Î’Î¿Î®Î¸ÎµÎ¹Î±';
                    } else {
                        hintBox.classList.add('show');
                        hintBtn.textContent = 'ğŸ”¼ Î‘Ï€ÏŒÎºÏÏ…ÏˆÎ·';
                    }
                });
            }
            
            document.querySelectorAll('.option-btn[data-value]').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (!state.answered) {
                        // Remove previous selection
                        document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                        
                        // Mark this as selected
                        btn.classList.add('selected');
                        selectedOption = parseInt(btn.dataset.value);
                        
                        // Auto-check after 1 second
                        setTimeout(() => {
                            if (selectedOption !== null && !state.answered) {
                                checkMultipleChoice(btn, selectedOption);
                            }
                        }, 1000);
                    }
                });
            });
            
            // Home button from quiz
            const homeFromQuizBtn = document.getElementById('homeFromQuizBtn');
            if (homeFromQuizBtn) {
                homeFromQuizBtn.addEventListener('click', () => {
                    if (confirm('Î˜Î­Î»ÎµÎ¹Ï‚ Î½Î± ÎµÏ€Î¹ÏƒÏ„ÏÎ­ÏˆÎµÎ¹Ï‚ ÏƒÏ„Î·Î½ Î±ÏÏ‡Î®; Î— Ï€ÏÏŒÎ¿Î´ÏŒÏ‚ ÏƒÎ¿Ï… Î¸Î± Ï‡Î±Î¸ÎµÎ¯.')) {
                        state.screen = 'selection';
                        state.selectedLevel = null;
                        state.selectedCount = null;
                        state.currentQuestion = 0;
                        state.answered = false;
                        state.correctCount = 0;
                        state.matchingPairs = {};
                        state.selectedWords = new Set();
                        questions = [];
                        wrongQuestions = [];
                        render();
                    }
                });
            }
            
            // Quiz screen - Fill Gap
            const checkGapBtn = document.getElementById('checkGapBtn');
            if (checkGapBtn) {
                checkGapBtn.addEventListener('click', checkGap);
            }
            
            const gapInput = document.getElementById('gapInput');
            if (gapInput) {
                gapInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !state.answered) {
                        checkGap();
                    }
                });
            }
            
            // Quiz screen - Matching (Drag & Drop)
            attachMatchingListeners();
            
            const checkMatchingBtn = document.getElementById('checkMatchingBtn');
            if (checkMatchingBtn) {
                checkMatchingBtn.addEventListener('click', checkMatching);
            }
            
            // Quiz screen - Pick Words
            attachPickWordsListeners();
            
            const checkPickWordsBtn = document.getElementById('checkPickWordsBtn');
            if (checkPickWordsBtn) {
                checkPickWordsBtn.addEventListener('click', checkPickWords);
            }
            
            // Results screen
            const repeatBtn = document.getElementById('repeatBtn');
            if (repeatBtn) {
                repeatBtn.addEventListener('click', repeatWrong);
            }
            
            const homeBtn = document.getElementById('homeBtn');
            if (homeBtn) {
                homeBtn.addEventListener('click', () => {
                    state.screen = 'selection';
                    state.selectedLevel = null;
                    state.selectedCount = null;
                    state.currentQuestion = 0;
                    state.answered = false;
                    state.correctCount = 0;
                    questions = [];
                    wrongQuestions = [];
                    render();
                });
            }
        }
        
        function attachMatchingListeners() {
            const matchingItems = document.querySelectorAll('.matching-item[draggable="true"]');
            const dropZones = document.querySelectorAll('.drop-zone');
            
            matchingItems.forEach(item => {
                // Mouse events (Desktop)
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                
                // Touch events (Mobile)
                item.addEventListener('touchstart', handleTouchStart);
                item.addEventListener('touchmove', handleTouchMove);
                item.addEventListener('touchend', handleTouchEnd);
            });
            
            dropZones.forEach(zone => {
                // Mouse events (Desktop)
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('drop', handleDrop);
                zone.addEventListener('dragleave', handleDragLeave);
            });
        }
        
        // Mouse Events (Desktop)
        function handleDragStart(e) {
            state.draggedItem = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML);
        }
        
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            e.target.closest('.drop-zone').classList.add('drag-over');
            return false;
        }
        
        function handleDragLeave(e) {
            e.target.closest('.drop-zone').classList.remove('drag-over');
        }
        
        // Touch Events (Mobile)
        let touchStartX, touchStartY;
        let clone = null;
        
        function handleTouchStart(e) {
            state.draggedItem = e.target.closest('.matching-item');
            const touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
            
            // Create a clone for visual feedback
            clone = state.draggedItem.cloneNode(true);
            clone.style.position = 'fixed';
            clone.style.opacity = '0.7';
            clone.style.pointerEvents = 'none';
            clone.style.zIndex = '1000';
            clone.style.width = state.draggedItem.offsetWidth + 'px';
            document.body.appendChild(clone);
            
            state.draggedItem.classList.add('dragging');
            e.preventDefault();
        }
        
        function handleTouchMove(e) {
            if (!state.draggedItem) return;
            
            const touch = e.touches[0];
            
            // Move the clone with finger
            if (clone) {
                clone.style.left = (touch.clientX - clone.offsetWidth / 2) + 'px';
                clone.style.top = (touch.clientY - clone.offsetHeight / 2) + 'px';
            }
            
            // Auto-scroll when near edges
            const scrollThreshold = 100; // pixels from edge to start scrolling
            const scrollSpeed = 15;
            
            if (touch.clientY < scrollThreshold) {
                // Near top - scroll up
                window.scrollBy(0, -scrollSpeed);
            } else if (touch.clientY > window.innerHeight - scrollThreshold) {
                // Near bottom - scroll down
                window.scrollBy(0, scrollSpeed);
            }
            
            // Check if over a drop zone
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            const dropZone = elementBelow ? elementBelow.closest('.drop-zone') : null;
            
            // Remove all drag-over classes
            document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('drag-over'));
            
            // Add drag-over to current zone
            if (dropZone) {
                dropZone.classList.add('drag-over');
            }
            
            e.preventDefault();
        }
        
        function handleTouchEnd(e) {
            if (!state.draggedItem) return;
            
            const touch = e.changedTouches[0];
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            const dropZone = elementBelow ? elementBelow.closest('.drop-zone') : null;
            
            // Remove clone
            if (clone) {
                document.body.removeChild(clone);
                clone = null;
            }
            
            state.draggedItem.classList.remove('dragging');
            
            // Handle drop if over a valid zone
            if (dropZone) {
                dropZone.classList.remove('drag-over');
                performDrop(dropZone);
            }
            
            state.draggedItem = null;
            e.preventDefault();
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            const dropZone = e.target.closest('.drop-zone');
            dropZone.classList.remove('drag-over');
            
            performDrop(dropZone);
            
            return false;
        }
        
        function performDrop(dropZone) {
            if (state.draggedItem) {
                const leftId = state.draggedItem.dataset.leftId;
                const rightId = dropZone.dataset.rightId;
                const label = state.draggedItem.dataset.label;
                
                // Remove previous match for this left item
                Object.keys(state.matchingPairs).forEach(key => {
                    if (state.matchingPairs[key].leftId === leftId) {
                        delete state.matchingPairs[key];
                    }
                });
                
                // Add new match
                state.matchingPairs[rightId] = {
                    leftId: leftId,
                    label: label,
                    content: state.draggedItem.textContent.replace(label, '').trim()
                };
                
                // Update UI - Î§Î©Î¡Î™Î£ Ï„Î·Î½ ÎºÎ»Î¬ÏƒÎ· matched (Î¸Î± Ï€ÏÎ¿ÏƒÏ„ÎµÎ¸ÎµÎ¯ Î¼ÏŒÎ½Î¿ Î¼ÎµÏ„Î¬ Ï„Î¿Î½ Î­Î»ÎµÎ³Ï‡Î¿)
                const content = dropZone.querySelector('.drop-zone-content');
                content.innerHTML = `<div class="matching-item">
                    <span class="matching-label">${label}</span>
                    ${state.matchingPairs[rightId].content}
                </div>`;
                
                dropZone.classList.add('filled');
                
                // Check if we can enable the check button
                const leftItems = document.querySelectorAll('.matching-item[draggable="true"]').length;
                const checkBtn = document.getElementById('checkMatchingBtn');
                if (checkBtn && Object.keys(state.matchingPairs).length >= leftItems) {
                    checkBtn.disabled = false;
                }
            }
        }
        
        function attachPickWordsListeners() {
            document.querySelectorAll('.pickable-word').forEach(word => {
                word.addEventListener('click', () => {
                    const wordText = word.dataset.word;
                    const isCorrect = word.dataset.isCorrect === 'true';
                    
                    // ÎœÏŒÎ½Î¿ Î±Î½ ÎµÎ¯Î½Î±Î¹ ÏƒÏ‰ÏƒÏ„Î® Î»Î­Î¾Î·, Ï€ÏÎ±ÏƒÎ¹Î½Î¯Î¶ÎµÎ¹
                    if (isCorrect) {
                        if (state.selectedWords.has(wordText)) {
                            // Deselect
                            state.selectedWords.delete(wordText);
                            word.classList.remove('selected');
                        } else {
                            // Select
                            state.selectedWords.add(wordText);
                            word.classList.add('selected');
                        }
                        
                        // Update counter
                        const counter = document.querySelector('.pick-words-counter');
                        if (counter) {
                            counter.textContent = `ÎˆÏ‡ÎµÏ„Îµ ÎµÏ€Î¹Î»Î­Î¾ÎµÎ¹ ÏƒÏ‰ÏƒÏ„Î¬: ${state.selectedWords.size} / ${state.requiredWords.length} Î»Î­Î¾ÎµÎ¹Ï‚`;
                        }
                        
                        // Enable/disable button
                        const checkBtn = document.getElementById('checkPickWordsBtn');
                        if (checkBtn) {
                            checkBtn.disabled = state.selectedWords.size !== state.requiredWords.length;
                        }
                    }
                    // Î‘Î½ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ ÏƒÏ‰ÏƒÏ„Î® â†’ Î´ÎµÎ½ ÎºÎ¬Î½ÎµÎ¹ Ï„Î¯Ï€Î¿Ï„Î±
                });
            });
        }

        // =====================================================
        // QUIZ LOGIC
        // =====================================================
        
        function startQuiz() {
            const typeMap = { 
                1: 'multiple_choice', 
                2: 'fill_gap',
                3: 'matching',
                4: 'pick_words'
            };
            let pool = allData.filter(q => q.question_type === typeMap[state.selectedLevel]);
            
            // Shuffle Î³Î¹Î± Ï„Ï…Ï‡Î±Î¯Î± ÏƒÎµÎ¹ÏÎ¬
            pool = shuffleArray(pool);
            
            if (state.selectedCount !== 'all') {
                pool = pool.slice(0, state.selectedCount);
            }
            
            questions = pool;
            wrongQuestions = [];
            state.currentQuestion = 0;
            state.answered = false;
            state.correctCount = 0;
            state.matchingPairs = {};
            state.selectedWords = new Set();
            state.screen = 'quiz';
            render();
        }
        
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        
        function checkMultipleChoice(btn, value) {
            state.answered = true;
            const q = questions[state.currentQuestion];
            const correct = Number(q.answer);
            
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(b => b.disabled = true);
            
            if (value === correct) {
                btn.classList.add('correct-answer');
                state.correctCount++;
                playCorrectSound();
            } else {
                btn.classList.add('wrong-answer');
                buttons[correct - 1].classList.add('correct-answer');
                wrongQuestions.push(q);
                playWrongSound();
            }
            
            showFeedback(q);
        }
        
        function checkGap() {
            if (state.answered) return;
            
            state.answered = true;
            const q = questions[state.currentQuestion];
            const input = document.getElementById('gapInput');
            
            // Î¥Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î· Ï€Î¿Î»Î»Î±Ï€Î»ÏÎ½ ÏƒÏ‰ÏƒÏ„ÏÎ½ Î±Ï€Î±Î½Ï„Î®ÏƒÎµÏ‰Î½ (Ï‡Ï‰ÏÎ¹ÏƒÎ¼Î­Î½ÎµÏ‚ Î¼Îµ ÎºÏŒÎ¼Î¼Î±)
            const correctAnswers = q.answer.split(',').map(a => normalize(a.trim()));
            const userAnswer = normalize(input.value);
            const isCorrect = correctAnswers.includes(userAnswer);
            
            input.classList.add(isCorrect ? 'correct' : 'wrong');
            input.disabled = true;
            document.getElementById('checkGapBtn').disabled = true;
            
            if (isCorrect) {
                state.correctCount++;
                playCorrectSound();
            } else {
                wrongQuestions.push(q);
                playWrongSound();
            }
            
            showFeedback(q, !isCorrect);
        }
        
        function checkMatching() {
            state.answered = true;
            const q = questions[state.currentQuestion];
            
            // Parse correct answers: "Î‘-2, Î’-4, Î“-1, Î”-3"
            const correctPairs = {};
            const pairs = q.answer.split(',').map(p => p.trim());
            
            pairs.forEach(pair => {
                // Match both Greek (Î‘-Î©) and Latin (A-Z) letters
                const match = pair.match(/([Î‘-Î©A-Z])-(\d+)/);
                if (match) {
                    const label = match[1];
                    const rightIndex = (parseInt(match[2]) - 1).toString();
                    correctPairs[label] = rightIndex;
                }
            });
            
            // Check answers
            let allCorrect = true;
            Object.keys(state.matchingPairs).forEach(rightId => {
                const pair = state.matchingPairs[rightId];
                const isCorrect = correctPairs[pair.label] === rightId;
                
                const dropZone = document.querySelector(`[data-right-id="${rightId}"]`);
                const matchedItem = dropZone.querySelector('.matching-item');
                
                if (isCorrect) {
                    matchedItem.classList.add('matched');
                    matchedItem.classList.remove('wrong');
                } else {
                    matchedItem.classList.add('wrong');
                    matchedItem.classList.remove('matched');
                    allCorrect = false;
                }
            });
            
            if (allCorrect) {
                state.correctCount++;
                playCorrectSound();
            } else {
                wrongQuestions.push(q);
                playWrongSound();
            }
            
            document.getElementById('checkMatchingBtn').disabled = true;
            
            // Show correct answers
            let correctAnswerText = 'Î£Ï‰ÏƒÏ„Î­Ï‚ Î±Î½Ï„Î¹ÏƒÏ„Î¿Î¹Ï‡Î¯ÏƒÎµÎ¹Ï‚: ';
            Object.keys(correctPairs).forEach(label => {
                const rightIndex = parseInt(correctPairs[label]) + 1;
                correctAnswerText += `${label}-${rightIndex}, `;
            });
            correctAnswerText = correctAnswerText.slice(0, -2);
            
            showFeedback(q, !allCorrect, correctAnswerText);
        }
        
        function checkPickWords() {
            state.answered = true;
            const q = questions[state.currentQuestion];
            
            // Check if all selected words are correct
            const selectedArray = Array.from(state.selectedWords);
            const allCorrect = selectedArray.every(word => 
                state.requiredWords.some(rw => normalize(rw) === normalize(word))
            ) && selectedArray.length === state.requiredWords.length;
            
            // Update UI
            document.querySelectorAll('.pickable-word.selected').forEach(word => {
                word.classList.add('correct');
            });
            
            document.getElementById('checkPickWordsBtn').disabled = true;
            
            if (allCorrect) {
                state.correctCount++;
                playCorrectSound();
            } else {
                wrongQuestions.push(q);
                playWrongSound();
            }
            
            showFeedback(q, !allCorrect, `Î£Ï‰ÏƒÏ„Î­Ï‚ Î»Î­Î¾ÎµÎ¹Ï‚: ${state.requiredWords.join(', ')}`);
        }
        
        function showFeedback(q, showCorrect = false, correctText = null) {
            let html = '<div class="feedback-container">';
            
            if (showCorrect && correctText) {
                html += `
                    <div class="correct-answer-box">
                        <h4>Î£Ï‰ÏƒÏ„Î® Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·:</h4>
                        <p>${correctText}</p>
                    </div>
                `;
            } else if (showCorrect && q.answer) {
                html += `
                    <div class="correct-answer-box">
                        <h4>Î£Ï‰ÏƒÏ„Î® Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·:</h4>
                        <p>${q.answer}</p>
                    </div>
                `;
            }
            
            // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Ï€Î±ÏÎ±Ï„Î·ÏÎ®ÏƒÎµÏ‰Î½ Î‘Î Î¥Î Î‘Î¡Î§ÎŸÎ¥Î (Î³Î¹Î± ÏŒÎ»Î¿Ï…Ï‚ Ï„Î¿Ï…Ï‚ Ï„ÏÏ€Î¿Ï…Ï‚ ÎµÏÏ‰Ï„Î®ÏƒÎµÏ‰Î½)
            if (q['Î Î±ÏÎ±Ï„Î·ÏÎ®ÏƒÎµÎ¹Ï‚'] && q['Î Î±ÏÎ±Ï„Î·ÏÎ®ÏƒÎµÎ¹Ï‚'].trim() !== '') {
                html += `
                    <div class="notes-box">
                        <h4>ğŸ’¡ Î Î±ÏÎ±Ï„Î®ÏÎ·ÏƒÎ·:</h4>
                        <p>${q['Î Î±ÏÎ±Ï„Î·ÏÎ®ÏƒÎµÎ¹Ï‚']}</p>
                    </div>
                `;
            }
            
            html += `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px;">
                    <button class="main-btn" id="homeBtn" style="background: #64748b; color: white;">
                        â¬… Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î®
                    </button>
                    <button class="main-btn success" id="nextBtn">
                        ${state.currentQuestion < questions.length - 1 ? 'Î•Ï€ÏŒÎ¼ÎµÎ½Î· â†’' : 'Î‘Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±'}
                    </button>
                </div>
            </div>`;
            
            document.getElementById('feedback').innerHTML = html;
            
            // Home button
            document.getElementById('homeBtn').addEventListener('click', () => {
                if (confirm('Î˜Î­Î»ÎµÎ¹Ï‚ Î½Î± ÎµÏ€Î¹ÏƒÏ„ÏÎ­ÏˆÎµÎ¹Ï‚ ÏƒÏ„Î·Î½ Î±ÏÏ‡Î®; Î— Ï€ÏÏŒÎ¿Î´ÏŒÏ‚ ÏƒÎ¿Ï… Î¸Î± Ï‡Î±Î¸ÎµÎ¯.')) {
                    state.screen = 'selection';
                    state.selectedLevel = null;
                    state.selectedCount = null;
                    state.currentQuestion = 0;
                    state.answered = false;
                    state.correctCount = 0;
                    state.matchingPairs = {};
                    state.selectedWords = new Set();
                    questions = [];
                    wrongQuestions = [];
                    render();
                }
            });
            
            // Next button
            document.getElementById('nextBtn').addEventListener('click', () => {
                if (state.currentQuestion < questions.length - 1) {
                    state.currentQuestion++;
                    state.answered = false;
                    state.matchingPairs = {};
                    state.selectedWords = new Set();
                    render();
                } else {
                    state.screen = 'results';
                    render();
                }
            });
        }
        
        function repeatWrong() {
            questions = [...wrongQuestions];
            wrongQuestions = [];
            state.currentQuestion = 0;
            state.answered = false;
            state.correctCount = 0;
            state.matchingPairs = {};
            state.selectedWords = new Set();
            state.screen = 'quiz';
            render();
        }

        // =====================================================
        // INIT
        // =====================================================
        loadData();
    </script>
</body>
</html>
